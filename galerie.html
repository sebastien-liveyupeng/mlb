<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Médias - Gascom Esport</title>
    <link rel="icon" type="image/png" href="assets/Ges-white.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;900&family=Russo+One&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
            .media-hero {
                padding: 7rem 2rem 3rem;
                text-align: center;
                background: radial-gradient(circle at top, rgba(255, 107, 53, 0.18) 0%, rgba(11, 11, 15, 0.95) 55%, rgba(11, 11, 15, 1) 100%);
                border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            }

            .media-hero h1 {
                font-family: 'Russo One', sans-serif;
                font-size: 2.7rem;
                color: #FFFFFF;
                margin-bottom: 0.8rem;
                background: linear-gradient(45deg, #9c2c17, #ff6b35);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .media-hero p {
                color: rgba(255, 255, 255, 0.75);
                max-width: 640px;
                margin: 0 auto;
                line-height: 1.6;
            }

            .media-wrapper {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
                display: flex;
                flex-direction: column;
                gap: 2rem;
            }

            .media-wrapper > section {
                width: 100%;
                max-width: 760px;
                margin: 0 auto;
            }

            .media-feed {
                max-width: 760px;
                margin: 0 auto;
                width: 100%;
            }

            .upload-card {
                background: rgba(15, 15, 22, 0.8);
                border: none;
                border-radius: 18px;
                padding: 1.4rem 1.5rem;
                box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25);
                position: relative;
                overflow: hidden;
            }

            .upload-card::after {
                content: none;
            }

            .upload-head {
                display: flex;
                flex-direction: column;
                gap: 0.4rem;
                margin-bottom: 1.2rem;
            }

            .upload-head h2 {
                color: #fff;
                font-size: 1.5rem;
            }

            .upload-head p {
                color: rgba(255, 255, 255, 0.6);
                font-size: 0.9rem;
            }

            .upload-form {
                display: grid;
                gap: 1rem;
            }

            .upload-form input[type="file"],
            .upload-form textarea {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 12px;
                color: #fff;
            }

            .upload-form button {
                width: 100%;
            }

            .upload-form input[type="file"] {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                border: 0;
            }

            .upload-file-label {
                display: inline-flex;
                align-items: center;
                gap: 0.6rem;
                padding: 0.7rem 1rem;
                border-radius: 12px;
                background: rgba(255, 107, 53, 0.2);
                border: 1px dashed rgba(255, 107, 53, 0.45);
                color: #fff;
                cursor: pointer;
                font-weight: 600;
            }

            .upload-form input[type="file"]::file-selector-button {
                display: none;
            }

            .upload-form textarea {
                min-height: 90px;
                padding: 0.8rem 1rem;
                resize: vertical;
            }

            .upload-form textarea:focus,
            .upload-form input[type="file"]:focus {
                outline: 2px solid rgba(255, 107, 53, 0.4);
                outline-offset: 2px;
            }

            .upload-form button {
                background: linear-gradient(135deg, #7c1808, #9c2c17);
                border: none;
                color: #fff;
                padding: 0.9rem 1.5rem;
                border-radius: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: transform 0.2s ease;
            }

            .upload-form button:hover {
                transform: translateY(-2px);
            }

            .upload-gate {
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 1rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 14px;
                padding: 0.9rem 1rem;
                border: 1px dashed rgba(255, 107, 53, 0.35);
                color: rgba(255, 255, 255, 0.7);
            }

            .upload-gate button {
                background: rgba(255, 107, 53, 0.15);
                border: 1px solid rgba(255, 107, 53, 0.5);
                padding: 0.6rem 1rem;
                color: #fff;
                border-radius: 10px;
                cursor: pointer;
            }

            .status {
                color: rgba(255, 255, 255, 0.7);
                font-size: 0.9rem;
                margin-top: 0.6rem;
            }

            .status.error {
                color: #ff7b7b;
            }

            .status.success {
                color: #7bffb4;
            }

            .feed-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 1rem;
                color: #fff;
                padding: 0 0.2rem;
            }

            .feed-header h2 {
                font-size: 1.5rem;
            }

            #feedCount {
                font-size: 0.9rem;
                color: rgba(255, 255, 255, 0.6);
                background: rgba(255, 255, 255, 0.06);
                padding: 0.35rem 0.8rem;
                border-radius: 999px;
            }

            .feed-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .media-card {
                background: rgba(15, 15, 22, 0.85);
                border-radius: 16px;
                border: none;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                gap: 0.8rem;
                padding-bottom: 1rem;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .media-card .media-header,
            .media-card .media-caption,
            .media-card .media-actions,
            .media-card .media-comments {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .media-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 16px 30px rgba(0, 0, 0, 0.35);
            }

            .media-card.highlight {
                outline: 2px solid rgba(156, 44, 23, 0.9);
                box-shadow: 0 0 0 3px rgba(156, 44, 23, 0.35), 0 20px 40px rgba(0, 0, 0, 0.4);
            }

            .media-lightbox {
                position: fixed;
                inset: 0;
                background: rgba(5, 5, 8, 0.92);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 2rem;
            }

            .media-lightbox.active {
                display: flex;
            }

            .media-lightbox-content {
                position: relative;
                max-width: 92vw;
                max-height: 88vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .media-lightbox img,
            .media-lightbox video {
                max-width: 92vw;
                max-height: 88vh;
                border-radius: 12px;
                background: #000;
            }

            .media-lightbox img {
                cursor: zoom-in;
                transition: transform 0.2s ease;
            }

            .media-lightbox img.zoomed {
                transform: scale(1.6);
                cursor: zoom-out;
            }

            .media-lightbox-close {
                position: absolute;
                top: -16px;
                right: -16px;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: rgba(255, 255, 255, 0.12);
                color: #fff;
                font-size: 1.4rem;
                cursor: pointer;
            }

            .media-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 1rem;
                padding: 1rem 1rem 0;
            }

            .media-user {
                display: flex;
                align-items: center;
                gap: 0.8rem;
            }

            .media-avatar {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                background: linear-gradient(135deg, #ff6b35, #9c2c17);
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                font-weight: 700;
                font-size: 1rem;
                overflow: hidden;
            }

            .media-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            .media-meta {
                display: flex;
                flex-direction: column;
            }

            .media-username {
                color: #fff;
                font-weight: 600;
            }

            .media-time {
                font-size: 0.8rem;
                color: rgba(255, 255, 255, 0.5);
            }

            .media-delete {
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                cursor: pointer;
            }

            .media-body img,
            .media-body video {
                width: 100%;
                max-height: 360px;
                object-fit: cover;
                background: #000;
                aspect-ratio: 16 / 9;
            }

            .media-body {
                position: relative;
            }

            .media-caption {
                color: rgba(255, 255, 255, 0.85);
                font-size: 0.95rem;
                line-height: 1.5;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .media-actions {
                display: flex;
                gap: 0.8rem;
                align-items: center;
            }

            .media-actions button {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.08);
                color: #fff;
                padding: 0.4rem 0.8rem;
                border-radius: 999px;
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                cursor: pointer;
                transition: background 0.2s ease, border-color 0.2s ease;
            }

            .media-actions button i {
                font-size: 1.1rem;
            }

            .media-actions button.liked {
                background: rgba(255, 107, 53, 0.2);
                border-color: rgba(255, 107, 53, 0.5);
            }

            .media-comments {
                display: none;
                flex-direction: column;
                gap: 0.8rem;
                border-top: 1px solid rgba(255, 255, 255, 0.06);
                padding-top: 0.8rem;
            }

            .media-comments.open {
                display: flex;
            }

            .comments-list {
                display: flex;
                flex-direction: column;
                gap: 0.6rem;
            }

            .comment-item {
                background: rgba(255, 255, 255, 0.04);
                border-radius: 10px;
                padding: 0.6rem 0.8rem;
                color: rgba(255, 255, 255, 0.85);
                font-size: 0.9rem;
            }

            .comment-meta {
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.5);
                margin-bottom: 0.3rem;
            }

            .comment-form {
                display: flex;
                gap: 0.6rem;
            }

            .comment-form input {
                flex: 1;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                padding: 0.5rem 0.8rem;
                color: #fff;
            }

            .comment-form input:focus {
                outline: 2px solid rgba(255, 107, 53, 0.4);
                outline-offset: 2px;
            }

            .comment-form button {
                background: rgba(255, 107, 53, 0.2);
                border: 1px solid rgba(255, 107, 53, 0.5);
                color: #fff;
                border-radius: 10px;
                padding: 0.5rem 1rem;
            }

            .load-more {
                margin: 0 auto;
                background: rgba(255, 255, 255, 0.06);
                border: 1px solid rgba(255, 255, 255, 0.15);
                color: #fff;
                padding: 0.6rem 1.2rem;
                border-radius: 999px;
                cursor: pointer;
                transition: background 0.2s ease, border-color 0.2s ease;
            }

            .load-more:hover {
                background: rgba(255, 107, 53, 0.18);
                border-color: rgba(255, 107, 53, 0.5);
            }

            @media (max-width: 768px) {
                .media-hero h1 {
                    font-size: 2rem;
                }
                .media-wrapper {
                    padding: 1.5rem;
                }
                .upload-card {
                    padding: 1.2rem;
                }
                .feed-header {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .media-actions {
                    flex-wrap: wrap;
                    gap: 0.6rem;
                }
                .media-body img,
                .media-body video {
                    max-height: 260px;
                }
                .comment-form {
                    flex-direction: column;
                }
                .comment-form button {
                    width: 100%;
                }
            }

            @media (max-width: 480px) {
                .media-hero {
                    padding: 6rem 1.2rem 2rem;
                }
                .media-wrapper {
                    padding: 1rem;
                }
                .upload-form button,
                .load-more {
                    width: 100%;
                }
                .media-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.6rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="background">
            <div class="animated-bg"></div>
        </div>

        <header>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo-icon">
                        <img src="assets/Ges-white.png" alt="Gascom Esport Logo" class="logo-img">
                    </div>
                    <div class="logo-text">Gascom Esport</div>
                </div>
                <nav>
                    <button class="hamburger" id="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div class="username-display-mobile" id="usernameDisplayMobile" style="display: none;">
                        <span id="usernameMobileNav"></span>
                        <button onclick="handleLogout()" class="logout-mobile-btn" title="Déconnexion">
                            <i class='bx bx-log-out'></i>
                        </button>
                    </div>
                    <ul class="nav-menu" id="navMenu">
                        <li class="nav-item"><a href="/">Accueil</a></li>
                        <li class="nav-item"><a href="/equipe">Équipe</a></li>
                        <li class="nav-item"><a href="/compositions">Compositions</a></li>
                        <li class="nav-item"><a href="/tournois">Tournois</a></li>
                        <li class="nav-item"><a href="/galerie" class="active">Galerie</a></li>
                        <li class="nav-item"><a href="/contact">Contact</a></li>
                        <li class="nav-item"><a href="/apropos">A propos</a></li>
                        <li class="nav-item"><a href="/profils">Profils</a></li>
                        <li class="nav-item"><a href="/chat"><i class='bx bx-message'></i> Chat</a></li>
                        <li class="nav-item auth-nav" id="authNav">
                            <button class="auth-btn" onclick="openLoginModal()">Connexion</button>
                            <button class="auth-btn" onclick="openSignupModal()">Inscription</button>
                        </li>
                        <li class="nav-item user-nav" id="userNav" style="display: none;">
                            <span class="username-display" id="usernameNav"></span>
                            <a class="logout-btn" href="/mon-profil" title="Mon Profil" style="background: transparent; border: none; color: #FFFFFF; cursor: pointer; padding: 0.5rem; font-size: 1.2rem; text-decoration: none;">
                                <i class='bx bx-user-circle'></i>
                            </a>
                            <button class="logout-btn" onclick="handleLogout()">Déconnexion</button>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>

        <section class="media-hero">
            <h1>Medias Gascom</h1>
            <p>Partagez vos gameplays, vos highlights et vos moments forts. Les membres connectés peuvent poster, tout le monde peut voir.</p>
        </section>

        <main class="media-wrapper">
            <section class="upload-card" id="uploadSection">
                <div class="upload-head">
                    <h2>Publier un média</h2>
                  
                </div>
                <div class="upload-gate" id="uploadGate">
                    <span>Connecte-toi pour publier un contenu.</span>
                    <button type="button" onclick="openLoginModal()">Se connecter</button>
                </div>
                <form class="upload-form" id="uploadForm" style="display: none;">
                    <label for="mediaFile" class="upload-file-label">
                        <i class='bx bx-image-alt'></i> Médias
                    </label>
                    <input type="file" id="mediaFile" accept="image/jpeg,image/png,image/webp,image/gif,video/mp4,video/webm,video/quicktime" required>
                    <textarea id="mediaCaption" maxlength="300" placeholder="Ajoute une description (optionnel)"></textarea>
                    <button type="submit">Publier</button>
                </form>
                <div class="status" id="uploadStatus"></div>
            </section>

            <section class="media-feed">
                <div class="feed-header">
                    <h2>Derniers posts</h2>
                    <span id="feedCount"></span>
                </div>
                <div class="status" id="feedStatus"></div>
                <div class="feed-grid" id="feedGrid"></div>
                <button class="load-more" id="loadMoreBtn">Charger plus</button>
            </section>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-logo">Gascom Esport</div>
                <p>&copy; 2024 Gascom Esport. Tous droits réservés.</p>
            </div>
        </footer>

        <div class="media-lightbox" id="mediaLightbox">
            <div class="media-lightbox-content" id="mediaLightboxContent">
                <button class="media-lightbox-close" id="mediaLightboxClose">×</button>
            </div>
        </div>

        <script src="auth-session.js"></script>
        <script>
            const PAGE_SIZE = 10;
            const MAX_IMAGE_SIZE = 1024 * 1024 * 1024; // 1 Go
            const MAX_VIDEO_SIZE = 2 * 1024 * 1024 * 1024; // 2 Go
            const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            const ALLOWED_VIDEO_TYPES = ['video/mp4', 'video/webm', 'video/quicktime'];

            const uploadForm = document.getElementById('uploadForm');
            const uploadGate = document.getElementById('uploadGate');
            const uploadStatus = document.getElementById('uploadStatus');
            const feedGrid = document.getElementById('feedGrid');
            const feedStatus = document.getElementById('feedStatus');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const feedCount = document.getElementById('feedCount');

            let currentUser = null;
            let token = null;
            let offset = 0;
            let loading = false;
            let hasMore = true;

            function setStatus(element, message, type) {
                if (!element) return;
                element.textContent = message || '';
                element.classList.remove('error', 'success');
                if (type) element.classList.add(type);
            }

            function formatDate(value) {
                if (!value) return '';
                return new Date(value).toLocaleString('fr-FR');
            }

            function getAvatarInitial(name) {
                return (name || 'M')[0].toUpperCase();
            }

            async function loadCurrentUser() {
                token = getStoredToken();
                if (!token) return;

                try {
                    const response = await fetch('/api/auth/session', {
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok && data.user) {
                        currentUser = data.user;
                    }
                } catch (error) {
                    console.error(error);
                }
            }

            function updateUploadVisibility() {
                if (token && currentUser) {
                    uploadGate.style.display = 'none';
                    uploadForm.style.display = 'grid';
                } else {
                    uploadGate.style.display = 'flex';
                    uploadForm.style.display = 'none';
                }
            }

            function createMediaElement(post) {
                const wrapper = document.createElement('div');
                wrapper.className = 'media-body';
                if (post.media_type === 'video') {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.preload = 'metadata';
                    video.src = post.media_url;
                    wrapper.appendChild(video);
                } else {
                    const img = document.createElement('img');
                    img.src = post.media_url;
                    img.alt = post.caption || 'Media';
                    wrapper.appendChild(img);
                }
                return wrapper;
            }

            function renderPost(post, { prepend = false } = {}) {
                const card = document.createElement('article');
                card.className = 'media-card';
                card.dataset.postId = post.id;

                const header = document.createElement('div');
                header.className = 'media-header';

                const userWrap = document.createElement('div');
                userWrap.className = 'media-user';

                const avatar = document.createElement('div');
                avatar.className = 'media-avatar';
                if (post.avatar_url) {
                    const avatarImg = document.createElement('img');
                    avatarImg.src = post.avatar_url;
                    avatarImg.alt = post.username || post.email || 'Avatar';
                    avatar.appendChild(avatarImg);
                } else {
                    avatar.textContent = getAvatarInitial(post.username || post.email);
                }

                const meta = document.createElement('div');
                meta.className = 'media-meta';
                const username = document.createElement('div');
                username.className = 'media-username';
                username.textContent = post.username || post.email || 'Membre';
                const time = document.createElement('div');
                time.className = 'media-time';
                time.textContent = formatDate(post.created_at);
                meta.appendChild(username);
                meta.appendChild(time);

                userWrap.appendChild(avatar);
                userWrap.appendChild(meta);
                header.appendChild(userWrap);

                if (currentUser && post.user_id === currentUser.id) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'media-delete';
                    deleteBtn.dataset.action = 'delete';
                    deleteBtn.innerHTML = "<i class='bx bx-trash'></i>";
                    header.appendChild(deleteBtn);
                }

                card.appendChild(header);
                card.appendChild(createMediaElement(post));

                if (post.caption) {
                    const caption = document.createElement('div');
                    caption.className = 'media-caption';
                    caption.textContent = post.caption;
                    card.appendChild(caption);
                }

                const actions = document.createElement('div');
                actions.className = 'media-actions';

                const likeBtn = document.createElement('button');
                likeBtn.dataset.action = 'like';
                likeBtn.className = post.liked_by_me ? 'liked' : '';
                likeBtn.innerHTML = `<i class='bx bxs-heart'></i> <span class="like-count">${post.like_count || 0}</span>`;

                const commentBtn = document.createElement('button');
                commentBtn.dataset.action = 'toggle-comments';
                commentBtn.innerHTML = `<i class='bx bx-message'></i> <span class="comment-count">${post.comment_count || 0}</span>`;

                actions.appendChild(likeBtn);
                actions.appendChild(commentBtn);
                card.appendChild(actions);

                const commentsSection = document.createElement('div');
                commentsSection.className = 'media-comments';

                const commentsList = document.createElement('div');
                commentsList.className = 'comments-list';
                commentsSection.appendChild(commentsList);

                const commentsStatus = document.createElement('div');
                commentsStatus.className = 'status';
                commentsSection.appendChild(commentsStatus);

                if (token) {
                    const commentForm = document.createElement('form');
                    commentForm.className = 'comment-form';
                    commentForm.innerHTML = `
                        <input type="text" maxlength="500" placeholder="Écrire un commentaire...">
                        <button type="submit">Envoyer</button>
                    `;
                    commentsSection.appendChild(commentForm);
                }

                card.appendChild(commentsSection);

                if (prepend) {
                    feedGrid.prepend(card);
                } else {
                    feedGrid.appendChild(card);
                }
            }

            function highlightPost(card) {
                if (!card) return;
                card.classList.add('highlight');
                setTimeout(() => card.classList.remove('highlight'), 2200);
            }

            function scrollToPost(postId) {
                if (!postId || !feedGrid) return false;
                const card = feedGrid.querySelector(`.media-card[data-post-id="${postId}"]`);
                if (!card) return false;
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                highlightPost(card);
                const comments = card.querySelector('.media-comments');
                if (comments) {
                    comments.classList.add('open');
                    if (card.dataset.commentsLoaded !== 'true') {
                        loadComments(card);
                    }
                }
                return true;
            }

            async function ensurePostVisible(postId) {
                if (!postId) return;
                let attempts = 0;
                while (attempts < 6) {
                    if (scrollToPost(postId)) return;
                    if (!hasMore) return;
                    await loadFeed();
                    attempts += 1;
                }
            }

            async function loadFeed(reset = false) {
                if (loading || (!hasMore && !reset)) return;
                loading = true;
                setStatus(feedStatus, 'Chargement...', '');

                if (reset) {
                    offset = 0;
                    hasMore = true;
                    feedGrid.innerHTML = '';
                }

                try {
                    const response = await fetch(`/api/media/feed?limit=${PAGE_SIZE}&offset=${offset}`, {
                        headers: token ? { Authorization: `Bearer ${token}` } : {}
                    });
                    const data = await response.json();

                    if (!response.ok) {
                        setStatus(feedStatus, data.error || 'Impossible de charger le feed.', 'error');
                        return;
                    }

                    const posts = data.posts || [];
                    if (posts.length === 0 && offset === 0) {
                        setStatus(feedStatus, 'Aucun post pour le moment.', '');
                        loadMoreBtn.style.display = 'none';
                        return;
                    }

                    setStatus(feedStatus, '', '');
                    posts.forEach(post => renderPost(post));

                    offset += posts.length;
                    hasMore = data.hasMore;
                    loadMoreBtn.style.display = hasMore ? 'block' : 'none';
                    feedCount.textContent = `${offset} posts`;
                } catch (error) {
                    console.error(error);
                    setStatus(feedStatus, 'Erreur lors du chargement.', 'error');
                } finally {
                    loading = false;
                }
            }

            async function uploadMedia(event) {
                event.preventDefault();

                if (!token) {
                    openLoginModal();
                    return;
                }

                const fileInput = document.getElementById('mediaFile');
                const captionInput = document.getElementById('mediaCaption');
                const file = fileInput.files[0];

                if (!file) {
                    setStatus(uploadStatus, 'Choisis un fichier.', 'error');
                    return;
                }

                const isImage = ALLOWED_IMAGE_TYPES.includes(file.type);
                const isVideo = ALLOWED_VIDEO_TYPES.includes(file.type);

                if (!isImage && !isVideo) {
                    setStatus(uploadStatus, 'Format non supporté.', 'error');
                    return;
                }

                if (isImage && file.size > MAX_IMAGE_SIZE) {
                    setStatus(uploadStatus, 'Image trop lourde (max 1 Go).', 'error');
                    return;
                }
                if (isVideo && file.size > MAX_VIDEO_SIZE) {
                    setStatus(uploadStatus, 'Vidéo trop lourde (max 1 Go).', 'error');
                    return;
                }
                setStatus(uploadStatus, 'Upload en cours...', '');
                const formData = new FormData();
                formData.append('file', file);
                formData.append('caption', captionInput.value || '');
                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        setStatus(uploadStatus, data.error || 'Upload échoué.', 'error');
                        return;
                    }
                    setStatus(uploadStatus, 'Publié !', 'success');
                    fileInput.value = '';
                    captionInput.value = '';
                    // Ajoute le média à la galerie
                    renderPost({
                        media_type: isVideo ? 'video' : 'image',
                        media_url: data.fileUrl,
                        caption: captionInput.value,
                        created_at: new Date().toISOString(),
                        username: currentUser ? currentUser.username : 'Membre'
                    }, { prepend: true });
                    offset += 1;
                } catch (error) {
                    console.error(error);
                    setStatus(uploadStatus, 'Erreur lors de l\'upload.', 'error');
                }
            }

            async function loadComments(card) {
                const postId = card.dataset.postId;
                const list = card.querySelector('.comments-list');
                const status = card.querySelector('.media-comments .status');

                setStatus(status, 'Chargement...', '');

                try {
                    const response = await fetch(`/api/media/comments?postId=${encodeURIComponent(postId)}`);
                    const data = await response.json();
                    if (!response.ok) {
                        setStatus(status, data.error || 'Erreur chargement.', 'error');
                        return;
                    }

                    list.innerHTML = '';
                    (data.comments || []).forEach(comment => {
                        const item = document.createElement('div');
                        item.className = 'comment-item';
                        item.innerHTML = `
                            <div class="comment-meta">${comment.username || 'Membre'} • ${formatDate(comment.created_at)}</div>
                            <div>${comment.content}</div>
                        `;
                        list.appendChild(item);
                    });

                    if (!(data.comments || []).length) {
                        setStatus(status, 'Aucun commentaire.', '');
                    } else {
                        setStatus(status, '', '');
                    }

                    card.dataset.commentsLoaded = 'true';
                } catch (error) {
                    console.error(error);
                    setStatus(status, 'Erreur chargement.', 'error');
                }
            }

            async function handleLike(card, button) {
                if (!token) {
                    openLoginModal();
                    return;
                }

                const postId = card.dataset.postId;
                try {
                    const response = await fetch('/api/media/like', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ postId })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        return;
                    }

                    button.classList.toggle('liked', data.liked);
                    const countEl = button.querySelector('.like-count');
                    if (countEl) countEl.textContent = data.like_count;
                } catch (error) {
                    console.error(error);
                }
            }

            async function handleCommentSubmit(event) {
                const form = event.target;
                if (!form.classList.contains('comment-form')) return;
                event.preventDefault();

                if (!token) {
                    openLoginModal();
                    return;
                }

                const card = form.closest('.media-card');
                const input = form.querySelector('input');
                const value = (input.value || '').trim();

                if (!value) return;

                try {
                    const response = await fetch('/api/media/comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ postId: card.dataset.postId, content: value })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        return;
                    }

                    const list = card.querySelector('.comments-list');
                    const newItem = document.createElement('div');
                    newItem.className = 'comment-item';
                    newItem.innerHTML = `
                        <div class="comment-meta">${data.comment.username || 'Membre'} • ${formatDate(data.comment.created_at)}</div>
                        <div>${data.comment.content}</div>
                    `;
                    list.appendChild(newItem);
                    input.value = '';

                    const countEl = card.querySelector('.comment-count');
                    if (countEl) countEl.textContent = data.comment_count;
                } catch (error) {
                    console.error(error);
                }
            }

            async function handleDelete(card) {
                if (!token) return;
                const postId = card.dataset.postId;
                const confirmed = confirm('Supprimer ce post ?');
                if (!confirmed) return;

                try {
                    const response = await fetch('/api/media/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ postId })
                    });

                    if (response.ok) {
                        card.remove();
                    }
                } catch (error) {
                    console.error(error);
                }
            }

            document.addEventListener('DOMContentLoaded', async () => {
                const hamburger = document.getElementById('hamburger');
                const navMenu = document.getElementById('navMenu');

                if (hamburger && navMenu) {
                    hamburger.addEventListener('click', () => {
                        navMenu.classList.toggle('active');
                        hamburger.classList.toggle('active');
                    });

                    document.querySelectorAll('.nav-menu a').forEach(link => {
                        link.addEventListener('click', () => {
                            navMenu.classList.remove('active');
                            hamburger.classList.remove('active');
                        });
                    });
                }

                await loadCurrentUser();
                updateUploadVisibility();
                await loadFeed(true);
                const targetPostId = new URLSearchParams(window.location.search).get('post');
                if (targetPostId) {
                    await ensurePostVisible(targetPostId);
                }
            });

            if (uploadForm) {
                uploadForm.addEventListener('submit', uploadMedia);
            }

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => loadFeed());
            }

            if (feedGrid) {
                feedGrid.addEventListener('click', (event) => {
                    const mediaTarget = event.target.closest('.media-body img, .media-body video');
                    if (mediaTarget) {
                        openLightbox(mediaTarget);
                        return;
                    }

                    const button = event.target.closest('button[data-action]');
                    if (!button) return;
                    const card = button.closest('.media-card');
                    if (!card) return;

                    const action = button.dataset.action;
                    if (action === 'like') {
                        handleLike(card, button);
                    } else if (action === 'toggle-comments') {
                        const comments = card.querySelector('.media-comments');
                        comments.classList.toggle('open');
                        if (comments.classList.contains('open') && card.dataset.commentsLoaded !== 'true') {
                            loadComments(card);
                        }
                    } else if (action === 'delete') {
                        handleDelete(card);
                    }
                });

                feedGrid.addEventListener('submit', handleCommentSubmit);
            }

            const lightbox = document.getElementById('mediaLightbox');
            const lightboxContent = document.getElementById('mediaLightboxContent');
            const lightboxClose = document.getElementById('mediaLightboxClose');

            function openLightbox(target) {
                if (!lightbox || !lightboxContent) return;

                const existing = lightboxContent.querySelector('img, video');
                if (existing) existing.remove();

                let mediaEl;
                if (target.tagName.toLowerCase() === 'video') {
                    mediaEl = document.createElement('video');
                    mediaEl.controls = true;
                    mediaEl.src = target.currentSrc || target.src;
                    mediaEl.preload = 'metadata';
                } else {
                    mediaEl = document.createElement('img');
                    mediaEl.src = target.src;
                    mediaEl.alt = target.alt || 'Media';
                    mediaEl.addEventListener('click', () => {
                        mediaEl.classList.toggle('zoomed');
                    });
                }

                lightboxContent.appendChild(mediaEl);
                lightbox.classList.add('active');
            }

            function closeLightbox() {
                if (!lightbox) return;
                lightbox.classList.remove('active');
                const media = lightboxContent.querySelector('video');
                if (media) {
                    media.pause();
                }
                const img = lightboxContent.querySelector('img');
                if (img) {
                    img.classList.remove('zoomed');
                }
            }

            if (lightboxClose) {
                lightboxClose.addEventListener('click', closeLightbox);
            }

            if (lightbox) {
                lightbox.addEventListener('click', (event) => {
                    if (event.target === lightbox) {
                        closeLightbox();
                    }
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeLightbox();
                }
            });
        </script>
    </body>
    </html>
